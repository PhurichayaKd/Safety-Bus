<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Safety Bus - ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏£‡∏ñ‡∏ö‡∏±‡∏™</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #000;
        }

        .header {
            background: white;
            color: #000;
            padding: 15px 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 20px;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .controls {
            padding: 15px 20px;
            background: white;
            border-bottom: 1px solid #e1e5e9;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            color: #000;
        }

        .last-update {
            font-size: 12px;
            color: #333;
        }

        .stats {
            display: flex;
            gap: 15px;
            font-size: 12px;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stat-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .stat-dot.bus { background: #ff6b6b; }
        .stat-dot.home { background: #4ecdc4; }
        .stat-dot.school { background: #45b7d1; }

        .map-container {
            position: relative;
            height: calc(100vh - 140px);
            background: white;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            color: #000;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            z-index: 1000;
            display: none;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            color: #000;
            border: 2px solid #ff6b6b;
            padding: 10px 20px;
            border-radius: 8px;
            z-index: 1001;
            display: none;
            max-width: 90%;
            text-align: center;
        }

        .error.show {
            display: block;
        }

        .auto-refresh-indicator {
            font-size: 11px;
            color: #999;
            font-style: italic;
        }

        /* Custom marker styles */
        .bus-icon {
            background: #ff6b6b;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: white;
            position: relative;
        }

        .bus-icon.realtime {
            background: #28a745;
        }

        .bus-icon.offline {
            background: #ffc107;
        }

        .home-icon {
            background: #4ecdc4;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: white;
        }

        .school-icon {
            background: #45b7d1;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: white;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üöå Safety Bus</h1>
        <p>‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏£‡∏ñ‡∏ö‡∏±‡∏™‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå</p>
    </div>

    <div class="controls">
        <div class="stats">
            <div class="stat-item">
                <div class="stat-dot bus"></div>
                <span id="bus-count">0 ‡∏£‡∏ñ‡∏ö‡∏±‡∏™</span>
            </div>
            <div class="stat-item">
                <div class="stat-dot home"></div>
                <span id="home-count">0 ‡∏ö‡πâ‡∏≤‡∏ô</span>
            </div>
            <div class="stat-item">
                <div class="stat-dot school"></div>
                <span id="school-count">0 ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span>
            </div>

        </div>
        
        <div>
            <div class="last-update">
                ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: <span id="last-update-time">-</span>
            </div>
            <div class="auto-refresh-indicator">
                ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏∏‡∏Å 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
            </div>
        </div>
    </div>

    <div class="map-container">
        <div id="map"></div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <div>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
        </div>
        
        <div class="error" id="error"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map;
        let markers = [];
        let isLoading = false;

        // Initialize map
        function initMap() {
            // Center map on Thailand (approximate center)
            map = L.map('map').setView([16.2498137, 103.2557912], 13);

            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 18
            }).addTo(map);
        }

        // Show/hide loading indicator
        function showLoading(show) {
            isLoading = show;
            const loading = document.getElementById('loading');
            if (show) {
                loading.classList.add('show');
            } else {
                loading.classList.remove('show');
            }
        }

        // Show error message
        function showError(message) {
            const error = document.getElementById('error');
            error.textContent = message;
            error.classList.add('show');
            
            // Hide error after 5 seconds
            setTimeout(() => {
                error.classList.remove('show');
            }, 5000);
        }

        // Clear all markers
        function clearMarkers() {
            markers.forEach(marker => {
                map.removeLayer(marker);
            });
            markers = [];
        }

        // Create custom icon
        function createCustomIcon(type, isRealTime = false) {
            let iconHtml = '';
            let className = '';
            
            switch(type) {
                case 'bus':
                    iconHtml = 'üöå';
                    className = 'bus-icon';
                    if (isRealTime) {
                        iconHtml += '<div style="position: absolute; top: -2px; right: -2px; width: 8px; height: 8px; background: #00ff00; border-radius: 50%; border: 1px solid white;"></div>';
                    }
                    break;
                case 'home':
                    iconHtml = 'üè†';
                    className = 'home-icon';
                    break;
                case 'school':
                    iconHtml = 'üè´';
                    className = 'school-icon';
                    break;
                default:
                    iconHtml = 'üöå';
                    className = 'bus-icon';
            }

            return L.divIcon({
                html: `<div class="${className}" style="position: relative;">${iconHtml}</div>`,
                className: 'custom-marker',
                iconSize: [30, 30],
                iconAnchor: [15, 15],
                popupAnchor: [0, -15]
            });
        }

        // Add marker to map
        function addMarker(bus) {
            // Add real-time bus location if available (priority: live_driver_locations data)
            if (bus.current_latitude && bus.current_longitude) {
                const isRealTime = bus.last_location_update ? true : false;
                const busIcon = createCustomIcon('bus', isRealTime);
                const busMarker = L.marker([bus.current_latitude, bus.current_longitude], {
                    icon: busIcon
                }).addTo(map);

                const lastUpdate = bus.last_location_update ? 
                    new Date(bus.last_location_update).toLocaleString('th-TH') : '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö';

                const locationSource = isRealTime ? 'üìç ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå' : 'üìç ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î';
                const connectionStatus = bus.status === 'active' ? 'üü¢ ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå' : 'üî¥ ‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå';

                busMarker.bindPopup(`
                    <div style="text-align: center;">
                        <h4>üöå ${bus.license_plate}</h4>
                        <p><strong>‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö:</strong> ${bus.driver_name}</p>
                        <p><strong>‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á:</strong> ${bus.route_id || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</p>
                        <p><strong>‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ö‡∏ô‡∏£‡∏ñ:</strong> ${bus.student_count} ‡∏Ñ‡∏ô</p>
                        <p><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠:</strong> ${connectionStatus}</p>
                        <p><strong>‡∏£‡∏∞‡∏¢‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á:</strong> ${bus.trip_phase === 'go' ? '‡πÑ‡∏õ' : bus.trip_phase === 'return' ? '‡∏Å‡∏•‡∏±‡∏ö' : bus.trip_phase === 'completed' ? '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' : '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö'}</p>
                        <p><strong>${locationSource}</strong></p>
                        <p><strong>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:</strong> ${lastUpdate}</p>
                    </div>
                `);

                markers.push(busMarker);
            }

            // Add home location if available
            if (bus.home_latitude && bus.home_longitude) {
                const homeIcon = createCustomIcon('home');
                const homeMarker = L.marker([bus.home_latitude, bus.home_longitude], {
                    icon: homeIcon
                }).addTo(map);

                homeMarker.bindPopup(`
                    <div style="text-align: center;">
                        <h4>üè† ‡∏ö‡πâ‡∏≤‡∏ô‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö</h4>
                        <p><strong>‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö:</strong> ${bus.driver_name}</p>
                        <p><strong>‡∏£‡∏ñ‡∏ö‡∏±‡∏™:</strong> ${bus.license_plate}</p>
                    </div>
                `);

                markers.push(homeMarker);
            }

            // Add school location if available
            if (bus.school_latitude && bus.school_longitude) {
                const schoolIcon = createCustomIcon('school');
                const schoolMarker = L.marker([bus.school_latitude, bus.school_longitude], {
                    icon: schoolIcon
                }).addTo(map);

                schoolMarker.bindPopup(`
                    <div style="text-align: center;">
                        <h4>üè´ ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h4>
                        <p><strong>‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á:</strong> ${bus.route_id || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</p>
                        <p><strong>‡∏£‡∏ñ‡∏ö‡∏±‡∏™:</strong> ${bus.license_plate}</p>
                    </div>
                `);

                markers.push(schoolMarker);
            }
        }

        // Update statistics
        function updateStats(buses) {
            let busCount = 0;
            let homeCount = 0;
            let schoolCount = 0;

            buses.forEach(bus => {
                if (bus.current_latitude && bus.current_longitude) {
                    busCount++;
                }
                if (bus.home_latitude && bus.home_longitude) homeCount++;
                if (bus.school_latitude && bus.school_longitude) schoolCount++;
            });

            document.getElementById('bus-count').textContent = `${busCount} ‡∏£‡∏ñ‡∏ö‡∏±‡∏™`;
            document.getElementById('home-count').textContent = `${homeCount} ‡∏ö‡πâ‡∏≤‡∏ô`;
            document.getElementById('school-count').textContent = `${schoolCount} ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô`;
        }

        // Load bus locations from API
        let isFirstLoad = true;

        function loadBusLocations() {
            if (isLoading) {
                console.log('Already loading, skipping...');
                return;
            }

            isLoading = true;

            // Only show loading indicator on first load
            if (isFirstLoad) {
                showLoading(true);
            }
            
            console.log('Loading bus locations...');
            
            const xhr = new XMLHttpRequest();
            xhr.open('GET', '/api/get-bus-locations', true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.setRequestHeader('Accept', 'application/json');
            
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    console.log('XHR status:', xhr.status);
                    
                    if (xhr.status === 200) {
                        try {
                            const data = JSON.parse(xhr.responseText);
                            console.log('Received data:', data);
                            
                            if (!data.success) {
                                throw new Error(data.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ');
                            }

                            // Clear existing markers
                            clearMarkers();

                            // Add new markers - use data.buses from the new API structure
                            const buses = data.buses || [];
                            buses.forEach(bus => {
                                addMarker(bus);
                            });

                            // Update statistics
                            updateStats(buses);

                            // Update last update time
                            document.getElementById('last-update-time').textContent = 
                                new Date().toLocaleString('th-TH');

                            console.log(`‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${buses.length} ‡∏£‡∏ñ‡∏ö‡∏±‡∏™, ${markers.length} markers`);

                            // Auto-fit map to show all markers (improved logic)
                            if (markers.length > 0) {
                                const group = new L.featureGroup(markers);
                                const bounds = group.getBounds();
                                
                                // If this is the first load or if we have valid bounds
                                if (isFirstLoad || bounds.isValid()) {
                                    map.fitBounds(bounds.pad(0.1));
                                    console.log('Map fitted to bounds:', bounds);
                                }
                            } else if (isFirstLoad) {
                                // If no markers, center on default location with appropriate zoom
                                map.setView([16.248, 103.25], 12);
                                console.log('No markers found, using default view');
                            }
                            
                        } catch (error) {
                            console.error('Error parsing JSON:', error);
                            showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ: ' + error.message);
                            // Show loading indicator when there's an error
                            if (!isFirstLoad) {
                                showLoading(true);
                                setTimeout(() => showLoading(false), 1000);
                            }
                        }
                    } else {
                        console.error('XHR error:', xhr.status, xhr.statusText);
                        console.error('Response text:', xhr.responseText);
                        showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ: HTTP ' + xhr.status);
                        // Show loading indicator when there's an error
                        if (!isFirstLoad) {
                            showLoading(true);
                            setTimeout(() => showLoading(false), 1000);
                        }
                    }
                    
                    if (isFirstLoad) {
                        showLoading(false);
                        isFirstLoad = false;
                    }
                    isLoading = false;
                }
            };
            
            xhr.onerror = function() {
                console.error('XHR network error');
                showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢');
                if (isFirstLoad) {
                    showLoading(false);
                    isFirstLoad = false;
                }
                isLoading = false;
            };
            
            xhr.send();
        }

        // Auto refresh every 5 seconds for real-time updates
        setInterval(() => {
            if (!isFirstLoad && !isLoading) {
                loadBusLocations();
            }
        }, 5000);

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            // Add a small delay before first API call
            setTimeout(() => {
                loadBusLocations();
            }, 1000);
        });
    </script>
</body>
</html>