import { supabase } from './supabaseClient';
import { sendEmergencyLineNotification } from './lineNotificationService';

export interface EmergencyLog {
  event_id: number;
  driver_id: number;
  event_time: string;
  event_type: 'PANIC_BUTTON' | 'SENSOR_ALERT' | 'DRIVER_INCAPACITATED' | 'SMOKE_DETECTED' | 'HIGH_TEMPERATURE' | 'MOVEMENT_DETECTED';
  triggered_by: 'sensor' | 'driver' | 'student';
  sensor_type?: 'PIR' | 'SMOKE_HEAT' | 'TEMPERATURE' | 'MOTION' | 'SMOKE' | string; // ‡πÄ‡∏û‡∏¥‡πà‡∏° sensor_type property
  description?: string;
  location?: string;
  notes?: string;
  resolved?: boolean;
  resolved_at?: string;
  resolved_by?: number;
  status?: 'pending' | 'checked' | 'emergency_confirmed' | 'resolved';
  details?: string | object; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏¥‡∏•‡∏î‡πå details ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á string ‡πÅ‡∏•‡∏∞ object)
  driver_response_type?: 'CHECKED' | 'EMERGENCY' | 'CONFIRMED_NORMAL';
  driver_response_time?: string;
  driver_response_notes?: string;
}

export interface EmergencyResponse {
  response_id?: number;
  event_id: number;
  driver_id: number;
  response_type: 'CHECKED' | 'EMERGENCY' | 'CONFIRMED_NORMAL';
  response_time: string;
  notes?: string;
  created_at?: string;
}

// ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• emergency logs ‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå
export const subscribeToEmergencyLogs = (
  driverId: number,
  onNewEmergency: (emergency: EmergencyLog) => void,
  onEmergencyUpdate: (emergency: EmergencyLog) => void
) => {
  const channel = supabase
    .channel('emergency-logs-realtime')
    .on(
      'postgres_changes',
      {
        event: 'INSERT',
        schema: 'public',
        table: 'emergency_logs',
        filter: `driver_id=eq.${driverId}`
      },
      (payload) => {
        console.log('New emergency event:', payload.new);
        onNewEmergency(payload.new as EmergencyLog);
      }
    )
    .on(
      'postgres_changes',
      {
        event: 'UPDATE',
        schema: 'public',
        table: 'emergency_logs',
        filter: `driver_id=eq.${driverId}`
      },
      (payload) => {
        console.log('Emergency event updated:', payload.new);
        onEmergencyUpdate(payload.new as EmergencyLog);
      }
    )
    .subscribe();

  return channel;
};

// ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• emergency logs ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
export const getRecentEmergencyLogs = async (driverId: number, limit: number = 10) => {
  try {
    const { data, error } = await supabase
      .from('emergency_logs')
      .select('*')
      .eq('driver_id', driverId)
      .order('event_time', { ascending: false })
      .limit(limit);

    if (error) throw error;
    return { data: data as EmergencyLog[], error: null };
  } catch (error) {
    console.error('Error fetching emergency logs:', error);
    return { data: null, error };
  }
};

// ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• emergency logs ‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
export const getUnresolvedEmergencyLogs = async (driverId: number) => {
  try {
    const { data, error } = await supabase
      .from('emergency_logs')
      .select('*')
      .eq('driver_id', driverId)
      .is('driver_response_type', null)
      .order('event_time', { ascending: false });

    if (error) throw error;
    return { data: data as EmergencyLog[], error: null };
  } catch (error) {
    console.error('Error fetching unresolved emergency logs:', error);
    return { data: null, error };
  }
};

// ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö
export const recordEmergencyResponse = async (
  eventId: number,
  responseType: 'CHECKED' | 'EMERGENCY' | 'CONFIRMED_NORMAL',
  driverId: number,
  notes?: string
) => {
  try {
    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á
    const { data: responseData, error: responseError } = await supabase
      .from('emergency_responses')
      .insert({
        event_id: eventId,
        driver_id: driverId,
        response_type: responseType,
        response_time: new Date().toISOString(),
        notes: notes
      })
      .select()
      .single();

    if (responseError) throw responseError;

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï driver_response_type ‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á emergency_logs
    const { error: updateError } = await supabase
      .from('emergency_logs')
      .update({
        driver_response_type: responseType,
        driver_response_time: new Date().toISOString(),
        driver_response_notes: notes || (responseType === 'CHECKED' 
          ? '‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß' 
          : responseType === 'EMERGENCY' 
            ? '‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏´‡∏ï‡∏∏‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô' 
            : '‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏õ‡∏Å‡∏ï‡∏¥')
      })
      .eq('event_id', eventId);

    if (updateError) {
      console.error('Error updating emergency log:', updateError);
      // ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ error ‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï emergency log ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß
    }

    // ‡∏™‡πà‡∏á LINE notification ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö EMERGENCY ‡πÅ‡∏•‡∏∞ CONFIRMED_NORMAL
    if (responseType === 'EMERGENCY' || responseType === 'CONFIRMED_NORMAL') {
      try {
        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• emergency log
        const { data: emergencyData, error: emergencyError } = await supabase
          .from('emergency_logs')
          .select('*')
          .eq('event_id', eventId)
          .single();

        if (!emergencyError && emergencyData) {
          await sendEmergencyLineNotification(emergencyData, responseType, driverId);
        }
      } catch (notificationError) {
        console.error('Error sending LINE notification:', notificationError);
        // ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ error ‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á notification ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß
      }
    }

    return { success: true, error: null, data: responseData };
  } catch (error) {
    console.error('Error recording emergency response:', error);
    return { success: false, error };
  }
};

// ‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÑ‡∏õ‡∏¢‡∏±‡∏á LINE
export const sendLineNotification = async (
  emergencyLog: EmergencyLog,
  responseType?: 'CHECKED' | 'EMERGENCY' | 'CONFIRMED_NORMAL'
) => {
  try {
    const baseUrl = process.env.EXPO_PUBLIC_LINE_NOTIFICATION_URL || 'http://localhost:3000';
    
    let message = '';
    
    if (responseType) {
      // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö
      if (responseType === 'CHECKED') {
        message = `üü¢ ‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß\n\n‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå: ${getEventTypeText(emergencyLog.event_type)}\n‡πÄ‡∏ß‡∏•‡∏≤: ${formatDateTime(emergencyLog.event_time)}\n‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡πà‡∏á‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥`;
      } else if (responseType === 'EMERGENCY') {
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≤‡∏°‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå
        const sensorDetails = getSensorDetailsMessage(emergencyLog.details);
        message = `üö® ‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏´‡∏ï‡∏∏‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô!\n\n${sensorDetails}\n‚ö†Ô∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏•‡∏á‡∏à‡∏≤‡∏Å‡∏£‡∏ñ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢\n‡πÄ‡∏ß‡∏•‡∏≤: ${formatDateTime(emergencyLog.event_time)}`;
      } else if (responseType === 'CONFIRMED_NORMAL') {
        message = `‚úÖ ‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏™‡∏π‡πà‡∏õ‡∏Å‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß\n\n‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå: ${getEventTypeText(emergencyLog.event_type)}\n‡πÄ‡∏ß‡∏•‡∏≤: ${formatDateTime(emergencyLog.event_time)}\n‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô`;
      }
    } else {
      // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÉ‡∏´‡∏°‡πà (‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏ñ‡πâ‡∏≤ triggered_by ‡πÄ‡∏õ‡πá‡∏ô student)
      if (emergencyLog.triggered_by === 'student') {
        return { success: true, error: null }; // ‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô LINE ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
      }
      
      message = `üö® ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô!\n\n‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ${getEventTypeText(emergencyLog.event_type)}\n‡πÄ‡∏ß‡∏•‡∏≤: ${formatDateTime(emergencyLog.event_time)}\n‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö: ${emergencyLog.driver_id}`;
      
      if (emergencyLog.description) {
        message += `\n‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ${emergencyLog.description}`;
      }
    }

    const response = await fetch(`${baseUrl}/api/emergency-notification`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        message: message,
        eventType: responseType ? undefined : emergencyLog.event_type,
        responseType: responseType,
        eventId: emergencyLog.event_id,
        description: emergencyLog.description,
        location: emergencyLog.location,
        notes: emergencyLog.notes,
        timestamp: emergencyLog.event_time,
        details: emergencyLog.details
      }),
    });

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    return { success: true, error: null };
  } catch (error) {
    console.error('Error sending LINE notification:', error);
    return { success: false, error };
  }
};

// Helper functions
export const getEventTypeText = (type: string) => {
  switch (type) {
    case 'PANIC_BUTTON':
      return '‡∏õ‡∏∏‡πà‡∏°‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô';
    case 'SENSOR_ALERT':
      return '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå';
    case 'DRIVER_INCAPACITATED':
      return '‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ç‡∏±‡∏ö‡πÑ‡∏î‡πâ';
    case 'SMOKE_DETECTED':
      return '‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏Ñ‡∏ß‡∏±‡∏ô';
    case 'HIGH_TEMPERATURE':
      return '‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡∏™‡∏π‡∏á';
    case 'MOVEMENT_DETECTED':
      return '‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß';
    default:
      return type;
  }
};

export const getTriggeredByText = (triggeredBy: string) => {
  switch (triggeredBy) {
    case 'sensor':
      return '‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå';
    case 'driver':
      return '‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö';
    case 'student':
      return '‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô';
    default:
      return triggeredBy;
  }
};

const getSensorDetailsMessage = (details: any): string => {
  if (!details) return '‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ö‡∏ô‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥';
  
  try {
    const detailsObj = typeof details === 'string' ? JSON.parse(details) : details;
    const sensors = [];
    
    if (detailsObj.temperature && detailsObj.temperature > 40) {
      sensors.push('‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡πâ‡∏≠‡∏ô‡∏™‡∏π‡∏á');
    }
    
    if (detailsObj.smoke && detailsObj.smoke > 50) {
      sensors.push('‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏Ñ‡∏ß‡∏±‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏°‡∏≤‡∏Å');
    }
    
    if (detailsObj.gas && detailsObj.gas > 30) {
      sensors.push('‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡πÅ‡∏Å‡πä‡∏™‡∏£‡∏±‡πà‡∏ß');
    }
    
    if (sensors.length === 0) {
      return '‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ö‡∏ô‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥';
    }
    
    const sensorText = sensors.join(' ‡πÅ‡∏•‡∏∞ ');
    return `‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ö‡∏ô‡∏£‡∏ñ ${sensorText} ‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏´‡∏ï‡∏∏‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô`;
  } catch (error) {
    return '‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ö‡∏ô‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ ‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏´‡∏ï‡∏∏‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô';
  }
};

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏õ‡∏•‡∏á details JSON ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢
export const parseDetails = (details: any): string => {
  if (!details) return '';
  
  // ‡∏ñ‡πâ‡∏≤ details ‡πÄ‡∏õ‡πá‡∏ô object ‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
  if (typeof details === 'object' && details !== null) {
    try {
      if (details.source && details.message) {
        return `‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå: ${details.source} - ${details.message}`;
      }
      if (details.source) {
        return `‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå: ${details.source}`;
      }
      if (details.message) {
        return `‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°: ${details.message}`;
      }
      // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ object ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ source ‡∏´‡∏£‡∏∑‡∏≠ message ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡πá‡∏ô JSON string
      return JSON.stringify(details);
    } catch {
      return '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå';
    }
  }
  
  // ‡∏ñ‡πâ‡∏≤ details ‡πÄ‡∏õ‡πá‡∏ô string ‡πÉ‡∏´‡πâ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏° parse
  if (typeof details === 'string') {
    try {
      const parsed = JSON.parse(details);
      if (parsed.source && parsed.message) {
        return `‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå: ${parsed.source} - ${parsed.message}`;
      }
      if (parsed.source) {
        return `‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå: ${parsed.source}`;
      }
      if (parsed.message) {
        return `‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°: ${parsed.message}`;
      }
      // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ object ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ source ‡∏´‡∏£‡∏∑‡∏≠ message ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡πá‡∏ô JSON string
      return JSON.stringify(parsed);
    } catch {
      // ‡∏ñ‡πâ‡∏≤ parse ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÉ‡∏´‡πâ return string ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏°‡∏≤
      return String(details);
    }
  }
  
  // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏ì‡∏µ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÉ‡∏´‡πâ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô string
  return String(details);
};

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå
export const getSourceText = (emergency: EmergencyLog): string => {
  // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÅ‡∏•‡∏∞‡∏°‡∏µ details ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å details
  if (['SENSOR_ALERT', 'SMOKE_DETECTED', 'HIGH_TEMPERATURE', 'MOVEMENT_DETECTED'].includes(emergency.event_type) && emergency.details) {
    return parseDetails(emergency.details);
  }
  // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏Å‡∏ï‡∏¥
  return getTriggeredByText(emergency.triggered_by);
};

export const formatDateTime = (dateTime: string) => {
  const date = new Date(dateTime);
  return date.toLocaleString('th-TH', {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
  });
};

export const getEventTypeIcon = (type: string) => {
  switch (type) {
    case 'PANIC_BUTTON':
      return 'warning';
    case 'SENSOR_ALERT':
      return 'alert-circle';
    case 'DRIVER_INCAPACITATED':
      return 'medical';
    case 'SMOKE_DETECTED':
      return 'cloud';
    case 'HIGH_TEMPERATURE':
      return 'thermometer';
    case 'MOVEMENT_DETECTED':
      return 'walk';
    default:
      return 'alert';
  }
};

export const getEventTypeColor = (type: string) => {
  switch (type) {
    case 'PANIC_BUTTON':
    case 'DRIVER_INCAPACITATED':
    case 'SMOKE_DETECTED':
      return '#EF4444'; // red
    case 'SENSOR_ALERT':
    case 'HIGH_TEMPERATURE':
    case 'MOVEMENT_DETECTED':
      return '#F59E0B'; // amber
    default:
      return '#6B7280'; // gray
  }
};