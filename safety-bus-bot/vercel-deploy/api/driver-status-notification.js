// API endpoint ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô LINE ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
import { createClient } from '@supabase/supabase-js';
import { Client } from '@line/bot-sdk';

const supabase = createClient(
  process.env.SUPABASE_URL,
  process.env.SUPABASE_ANON_KEY
);

// Initialize LINE client
let lineClient = null;
try {
  if (process.env.LINE_CHANNEL_ACCESS_TOKEN) {
    lineClient = new Client({
      channelAccessToken: process.env.LINE_CHANNEL_ACCESS_TOKEN
    });
  }
} catch (error) {
  console.error('Failed to initialize LINE client:', error);
}

// ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö
const DRIVER_STATUS_MESSAGES = {
  // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏≠‡∏Å‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á
  start_journey: {
    emoji: 'üöå',
    title: '‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏≠‡∏Å‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á',
    message: '‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡πÑ‡∏î‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏≠‡∏Å‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡πâ‡∏û‡∏£‡πâ‡∏≠‡∏°'
  },
  go: {
    emoji: 'üöå',
    title: '‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏≠‡∏Å‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á',
    message: '‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡πÑ‡∏î‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏≠‡∏Å‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡πâ‡∏û‡∏£‡πâ‡∏≠‡∏°'
  },
  // ‡∏ñ‡∏∂‡∏á‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
  arrived_school: {
    emoji: 'üè´',
    title: '‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏ñ‡∏∂‡∏á‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß',
    message: '‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏ñ‡∏∂‡∏á‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏á‡∏£‡∏ñ‡πÑ‡∏î‡πâ'
  },
  arrive_school: {
    emoji: 'üè´',
    title: '‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏ñ‡∏∂‡∏á‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß',
    message: '‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏ñ‡∏∂‡∏á‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏á‡∏£‡∏ñ‡πÑ‡∏î‡πâ'
  },
  // ‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏ô
  waiting_return: {
    emoji: '‚è∞',
    title: '‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏ô',
    message: '‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡πâ‡∏û‡∏£‡πâ‡∏≠‡∏°'
  },
  wait_pickup: {
    emoji: '‚è∞',
    title: '‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏ô',
    message: '‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡πâ‡∏û‡∏£‡πâ‡∏≠‡∏°'
  },
  // ‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á
  finished: {
    emoji: '‚úÖ',
    title: '‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á',
    message: '‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡πÑ‡∏î‡πâ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÑ‡∏î‡πâ‡∏Å‡∏•‡∏±‡∏ö‡∏ñ‡∏∂‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'
  },
  finish_journey: {
    emoji: '‚úÖ',
    title: '‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á',
    message: '‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡πÑ‡∏î‡πâ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÑ‡∏î‡πâ‡∏Å‡∏•‡∏±‡∏ö‡∏ñ‡∏∂‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'
  },
  // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ)
  return: {
    emoji: 'üè†',
    title: '‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏ô',
    message: '‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡πÑ‡∏î‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏™‡πà‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß'
  },
  pickup: {
    emoji: 'üìç',
    title: '‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏±‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô',
    message: '‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏£‡∏±‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏£‡∏ñ'
  },
  dropoff: {
    emoji: 'üè´',
    title: '‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô',
    message: '‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏™‡πà‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏•‡∏á‡∏£‡∏ñ'
  },
  driving: {
    emoji: 'üõ£Ô∏è',
    title: '‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á',
    message: '‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á'
  }
};

export default async function handler(req, res) {
  // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ CORS
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type, Authorization');

  if (req.method === 'OPTIONS') {
    return res.status(200).end();
  }

  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  try {
    const { 
      driver_id, 
      trip_phase, 
      current_status, 
      location,
      notes 
    } = req.body;

    // Validate required fields
    if (!driver_id || !trip_phase) {
      return res.status(400).json({ 
        error: 'driver_id and trip_phase are required' 
      });
    }

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ LINE
    if (!lineClient) {
      console.error('LINE client not initialized');
      return res.status(500).json({ 
        error: 'LINE messaging service not available' 
      });
    }

    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö
    const { data: driverData, error: driverError } = await supabase
      .from('driver_bus')
      .select(`
        driver_id,
        driver_name,
        license_plate,
        phone_number
      `)
      .eq('driver_id', driver_id)
      .single();

    if (driverError || !driverData) {
      return res.status(404).json({ 
        error: 'Driver not found' 
      });
    }

    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
    let messageInfo = DRIVER_STATUS_MESSAGES[current_status] || DRIVER_STATUS_MESSAGES[trip_phase];
    
    if (!messageInfo) {
      messageInfo = {
        emoji: 'üì¢',
        title: '‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞',
        message: `‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô ${current_status || trip_phase}`
      };
    }

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
    const currentTime = new Date().toLocaleString('th-TH', {
      timeZone: 'Asia/Bangkok',
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit'
    });

    let messageText = `${messageInfo.emoji} ${messageInfo.title}\n\n${messageInfo.message}`;
    
    messageText += `\n\nüë®‚Äç‚úàÔ∏è ‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö: ${driverData.driver_name}`;
    messageText += `\nüöå ‡∏£‡∏ñ‡πÄ‡∏°‡∏•‡πå: ${driverData.license_plate}`;
    
    if (location) {
      messageText += `\nüìç ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á: ${location}`;
    }
    
    if (notes) {
      messageText += `\nüìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${notes}`;
    }
    
    messageText += `\n\n‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤: ${currentTime}`;

    const lineMessage = {
      type: 'text',
      text: messageText
    };

    let notificationResults = [];

    // ‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÑ‡∏õ‡∏¢‡∏±‡∏á student_line_links ‡πÅ‡∏•‡∏∞ parent_line_links
    try {
      // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å student_line_links ‡∏û‡∏£‡πâ‡∏≠‡∏° join ‡∏Å‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á students
      const { data: studentLinks, error: studentError } = await supabase
        .from('student_line_links')
        .select(`
          line_user_id, 
          student_id,
          line_display_id,
          students!inner(student_name)
        `)
        .not('line_user_id', 'is', null)
        .neq('line_user_id', '');

      if (studentError) {
        console.error('Error fetching student links:', studentError);
      } else if (studentLinks && studentLinks.length > 0) {
        // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô
        for (const student of studentLinks) {
          try {
            await lineClient.pushMessage(student.line_user_id, lineMessage);
            const studentName = student.students?.student_name || student.line_display_id || 'Unknown Student';
            notificationResults.push({
              lineUserId: student.line_user_id,
              studentId: student.student_id,
              studentName: studentName,
              type: 'student',
              status: 'success'
            });
            console.log(`‚úÖ Driver status notification sent to student ${studentName} (${student.line_user_id})`);
          } catch (error) {
            const studentName = student.students?.student_name || student.line_display_id || 'Unknown Student';
            console.error(`‚ùå Failed to send to student ${studentName}:`, error);
            notificationResults.push({
              lineUserId: student.line_user_id,
              studentId: student.student_id,
              studentName: studentName,
              type: 'student',
              status: 'failed',
              error: error.message
            });
          }
        }
      } else {
        console.log('No student LINE links found');
      }

      // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å parent_line_links ‡∏û‡∏£‡πâ‡∏≠‡∏° join ‡∏Å‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á parents ‡πÅ‡∏•‡∏∞ students
      const { data: parentLinks, error: parentError } = await supabase
        .from('parent_line_links')
        .select(`
          line_user_id, 
          parent_id,
          line_display_id,
          parents!inner(parent_name),
          students!inner(student_name)
        `)
        .not('line_user_id', 'is', null)
        .neq('line_user_id', '');

      if (parentError) {
        console.error('Error fetching parent links:', parentError);
      } else if (parentLinks && parentLinks.length > 0) {
        // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô
        for (const parent of parentLinks) {
          try {
            await lineClient.pushMessage(parent.line_user_id, lineMessage);
            const parentName = parent.parents?.parent_name || parent.line_display_id || 'Unknown Parent';
            const studentName = parent.students?.student_name || 'Unknown Student';
            notificationResults.push({
              lineUserId: parent.line_user_id,
              parentId: parent.parent_id,
              parentName: parentName,
              studentName: studentName,
              type: 'parent',
              status: 'success'
            });
            console.log(`‚úÖ Driver status notification sent to parent ${parentName} (${parent.line_user_id})`);
          } catch (error) {
            const parentName = parent.parents?.parent_name || parent.line_display_id || 'Unknown Parent';
            const studentName = parent.students?.student_name || 'Unknown Student';
            console.error(`‚ùå Failed to send to parent ${parentName}:`, error);
            notificationResults.push({
              lineUserId: parent.line_user_id,
              parentId: parent.parent_id,
              parentName: parentName,
              studentName: studentName,
              type: 'parent',
              status: 'failed',
              error: error.message
            });
          }
        }
      } else {
        console.log('No parent LINE links found');
      }
    } catch (error) {
      console.error('Database query error:', error);
    }



    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å log ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
    try {
      await supabase
        .from('notification_logs')
        .insert({
          notification_type: 'driver_status_update',
          recipient_id: 'all_users',
          message: messageText,
          status: 'sent',
          sent_at: new Date().toISOString(),
          metadata: {
            driver_id,
            trip_phase,
            current_status,
            location,
            notes,
            notification_results: notificationResults
          }
        });
    } catch (logError) {
      console.error('Failed to log notification:', logError);
    }

    // Log ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
    console.log(`üì§ Driver status notification processed:`, {
      driver_id,
      trip_phase,
      current_status,
      location,
      totalSent: notificationResults.filter(r => r.status === 'success').length,
      totalFailed: notificationResults.filter(r => r.status === 'failed').length
    });

    return res.status(200).json({
      success: true,
      message: 'Driver status notification sent successfully',
      driver: {
        id: driver_id,
        name: driverData.driver_name,
        license_plate: driverData.license_plate
      },
      status: {
        trip_phase,
        current_status
      },
      notification_results: notificationResults,
      summary: {
        total_sent: notificationResults.filter(r => r.status === 'success').length,
        total_failed: notificationResults.filter(r => r.status === 'failed').length,
        students_notified: notificationResults.filter(r => r.type === 'student' && r.status === 'success').length,
        parents_notified: notificationResults.filter(r => r.type === 'parent' && r.status === 'success').length
      }
    });

  } catch (error) {
    console.error('Driver status notification error:', error);
    return res.status(500).json({
      success: false,
      error: 'Internal server error: ' + error.message
    });
  }
}