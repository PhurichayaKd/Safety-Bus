// API endpoint ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô LINE ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
import { createClient } from '@supabase/supabase-js';
import { Client } from '@line/bot-sdk';

const supabase = createClient(
  process.env.SUPABASE_URL,
  process.env.SUPABASE_ANON_KEY
);

// Initialize LINE client
let lineClient = null;
try {
  if (process.env.LINE_CHANNEL_ACCESS_TOKEN) {
    lineClient = new Client({
      channelAccessToken: process.env.LINE_CHANNEL_ACCESS_TOKEN
    });
  }
} catch (error) {
  console.error('Failed to initialize LINE client:', error);
}

// ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
const STUDENT_STATUS_MESSAGES = {
  onboard: {
    emoji: 'üöå',
    title: '‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏£‡∏ñ‡πÅ‡∏•‡πâ‡∏ß',
    message: '‡πÑ‡∏î‡πâ‡∏Ç‡∏∂‡πâ‡∏ô‡∏£‡∏ñ‡πÇ‡∏î‡∏¢‡∏™‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß'
  },
  offboard: {
    emoji: 'üè†',
    title: '‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏•‡∏á‡∏£‡∏ñ‡πÅ‡∏•‡πâ‡∏ß',
    message: '‡πÑ‡∏î‡πâ‡∏•‡∏á‡∏à‡∏≤‡∏Å‡∏£‡∏ñ‡πÇ‡∏î‡∏¢‡∏™‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß'
  },
  absent: {
    emoji: '‚ùå',
    title: '‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô',
    message: '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Ç‡∏∂‡πâ‡∏ô‡∏£‡∏ñ‡πÇ‡∏î‡∏¢‡∏™‡∏≤‡∏£ (‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô)'
  },
  stop: {
    emoji: '‚è∏Ô∏è',
    title: '‡∏´‡∏¢‡∏∏‡∏î‡∏£‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô',
    message: '‡∏£‡∏ñ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏´‡∏¢‡∏∏‡∏î‡∏£‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'
  }
};

export default async function handler(req, res) {
  // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ CORS
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type, Authorization');

  if (req.method === 'OPTIONS') {
    return res.status(200).end();
  }

  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  try {
    const { 
      student_id, 
      status, 
      driver_id,
      location,
      notes,
      phase = 'pickup' // pickup ‡∏´‡∏£‡∏∑‡∏≠ dropoff
    } = req.body;

    // Validate required fields
    if (!student_id || !status) {
      return res.status(400).json({ 
        error: 'student_id and status are required' 
      });
    }

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ LINE
    if (!lineClient) {
      console.error('LINE client not initialized');
      return res.status(500).json({ 
        error: 'LINE messaging service not available' 
      });
    }

    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
    const { data: studentData, error: studentError } = await supabase
      .from('students')
      .select(`
        student_id,
        student_name,
        student_code,
        class,
        pickup_location,
        dropoff_location
      `)
      .eq('student_id', student_id)
      .single();

    if (studentError || !studentData) {
      return res.status(404).json({ 
        error: 'Student not found' 
      });
    }

    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    let driverData = null;
    if (driver_id) {
      const { data: driver, error: driverError } = await supabase
        .from('driver_bus')
        .select(`
          driver_id,
          driver_name,
          bus_number,
          phone_number
        `)
        .eq('driver_id', driver_id)
        .single();

      if (!driverError && driver) {
        driverData = driver;
      }
    }

    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
    const messageInfo = STUDENT_STATUS_MESSAGES[status] || {
      emoji: 'üì¢',
      title: '‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô',
      message: `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡πÄ‡∏õ‡πá‡∏ô ${status}`
    };

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
    const currentTime = new Date().toLocaleString('th-TH', {
      timeZone: 'Asia/Bangkok',
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit'
    });

    let messageText = `${messageInfo.emoji} ${messageInfo.title}\n\n`;
    messageText += `üë®‚Äçüéì ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ${studentData.student_name}`;
    messageText += `\nüÜî ‡∏£‡∏´‡∏±‡∏™: ${studentData.student_code}`;
    messageText += `\nüè´ ‡∏ä‡∏±‡πâ‡∏ô: ${studentData.class}`;
    messageText += `\n\n${messageInfo.message}`;
    
    if (driverData) {
      messageText += `\n\nüë®‚Äç‚úàÔ∏è ‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö: ${driverData.driver_name}`;
      messageText += `\nüöå ‡∏£‡∏ñ‡πÄ‡∏°‡∏•‡πå: ${driverData.bus_number}`;
    }
    
    if (location) {
      messageText += `\nüìç ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á: ${location}`;
    } else {
      // ‡πÉ‡∏ä‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
      const studentLocation = phase === 'pickup' ? studentData.pickup_location : studentData.dropoff_location;
      if (studentLocation) {
        messageText += `\nüìç ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á: ${studentLocation}`;
      }
    }
    
    if (notes) {
      messageText += `\nüìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${notes}`;
    }
    
    messageText += `\n\n‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤: ${currentTime}`;

    const lineMessage = {
      type: 'text',
      text: messageText
    };

    let notificationResults = [];

    // ‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏±‡πâ‡∏ô
    try {
      const { data: studentLink, error: studentLinkError } = await supabase
        .from('student_line_links')
        .select('line_user_id, student_name')
        .eq('student_id', student_id)
        .not('line_user_id', 'is', null)
        .neq('line_user_id', '')
        .single();

      if (!studentLinkError && studentLink) {
        try {
          await lineClient.pushMessage(studentLink.line_user_id, lineMessage);
          notificationResults.push({
            lineUserId: studentLink.line_user_id,
            studentName: studentLink.student_name,
            type: 'student',
            status: 'success'
          });
          console.log(`‚úÖ Student status notification sent to student ${studentLink.student_name} (${studentLink.line_user_id})`);
        } catch (error) {
          console.error(`‚ùå Failed to send to student ${studentLink.student_name}:`, error);
          notificationResults.push({
            lineUserId: studentLink.line_user_id,
            studentName: studentLink.student_name,
            type: 'student',
            status: 'failed',
            error: error.message
          });
        }
      } else {
        console.log(`No LINE link found for student ${student_id}`);
      }
    } catch (error) {
      console.error('Error fetching student LINE link:', error);
    }

    // ‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏±‡πâ‡∏ô
    try {
      const { data: parentLinks, error: parentLinkError } = await supabase
        .from('parent_line_links')
        .select('line_user_id, parent_name, student_name')
        .eq('student_id', student_id)
        .not('line_user_id', 'is', null)
        .neq('line_user_id', '');

      if (!parentLinkError && parentLinks && parentLinks.length > 0) {
        for (const parent of parentLinks) {
          try {
            await lineClient.pushMessage(parent.line_user_id, lineMessage);
            notificationResults.push({
              lineUserId: parent.line_user_id,
              parentName: parent.parent_name,
              studentName: parent.student_name,
              type: 'parent',
              status: 'success'
            });
            console.log(`‚úÖ Student status notification sent to parent ${parent.parent_name} (${parent.line_user_id})`);
          } catch (error) {
            console.error(`‚ùå Failed to send to parent ${parent.parent_name}:`, error);
            notificationResults.push({
              lineUserId: parent.line_user_id,
              parentName: parent.parent_name,
              studentName: parent.student_name,
              type: 'parent',
              status: 'failed',
              error: error.message
            });
          }
        }
      } else {
        console.log(`No parent LINE links found for student ${student_id}`);
      }
    } catch (error) {
      console.error('Error fetching parent LINE links:', error);
    }

    // ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á Admin Group (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    const adminGroupId = process.env.LINE_ADMIN_GROUP_ID;
    if (adminGroupId) {
      try {
        await lineClient.pushMessage(adminGroupId, lineMessage);
        notificationResults.push({
          lineUserId: adminGroupId,
          type: 'admin_group',
          status: 'success'
        });
        console.log('‚úÖ Student status notification sent to admin group');
      } catch (error) {
        console.error('‚ùå Failed to send to admin group:', error);
        notificationResults.push({
          lineUserId: adminGroupId,
          type: 'admin_group',
          status: 'failed',
          error: error.message
        });
      }
    }

    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å log ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
    try {
      await supabase
        .from('notification_logs')
        .insert({
          notification_type: 'student_status_update',
          recipient_id: student_id,
          message: messageText,
          status: 'sent',
          sent_at: new Date().toISOString(),
          metadata: {
            student_id,
            status,
            driver_id,
            location,
            notes,
            phase,
            notification_results: notificationResults
          }
        });
    } catch (logError) {
      console.error('Failed to log notification:', logError);
    }

    // Log ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
    console.log(`üì§ Student status notification processed:`, {
      student_id,
      student_name: studentData.student_name,
      status,
      phase,
      location,
      totalSent: notificationResults.filter(r => r.status === 'success').length,
      totalFailed: notificationResults.filter(r => r.status === 'failed').length
    });

    return res.status(200).json({
      success: true,
      message: 'Student status notification sent successfully',
      student: {
        id: student_id,
        name: studentData.student_name,
        code: studentData.student_code,
        class: studentData.class
      },
      status: status,
      phase: phase,
      driver: driverData ? {
        id: driver_id,
        name: driverData.driver_name,
        bus_number: driverData.bus_number
      } : null,
      notification_results: notificationResults,
      summary: {
        total_sent: notificationResults.filter(r => r.status === 'success').length,
        total_failed: notificationResults.filter(r => r.status === 'failed').length,
        student_notified: notificationResults.filter(r => r.type === 'student' && r.status === 'success').length > 0,
        parents_notified: notificationResults.filter(r => r.type === 'parent' && r.status === 'success').length
      }
    });

  } catch (error) {
    console.error('Student status notification error:', error);
    return res.status(500).json({
      success: false,
      error: 'Internal server error: ' + error.message
    });
  }
}